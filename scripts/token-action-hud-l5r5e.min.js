const t={ID:"token-action-hud-l5r5e"},e={ID:"token-action-hud-core"},i="1.5",s={item:"tokenActionHud.template.item",utility:"tokenActionHud.utility"},n={armor:{id:"armor",name:"l5r5e.armors.title",type:"system"},equipment:{id:"equipment",name:"l5r5e.items.title",type:"system"},equipped:{id:"equipped",name:"Equipped",type:"system"},unequipped:{id:"unequipped",name:"Unequipped",type:"system"},weapons:{id:"weapons",name:"l5r5e.weapons.title",type:"system"},combat:{id:"combat",name:"tokenActionHud.combat",type:"system"},token:{id:"token",name:"tokenActionHud.token",type:"system"},utility:{id:"utility",name:"tokenActionHud.utility",type:"system"},rings:{id:"rings",name:"l5r5e.rings.title",type:"system"},derived:{id:"derived",name:"l5r5e.attributes.title",type:"system"},standing:{id:"standing",name:"l5r5e.social.title",type:"system"},artisan:{id:"artisan",name:"l5r5e.skills.artisan.title",type:"system"},martial:{id:"martial",name:"l5r5e.skills.martial.title",type:"system"},scholar:{id:"scholar",name:"l5r5e.skills.scholar.title",type:"system"},social:{id:"social",name:"l5r5e.skills.social.title",type:"system"},trade:{id:"trade",name:"l5r5e.skills.trade.title",type:"system"},kata:{id:"kata",name:"l5r5e.techniques.kata",type:"system"},kiho:{id:"kiho",name:"l5r5e.techniques.kiho",type:"system"},inversion:{id:"inversion",name:"l5r5e.techniques.inversion",type:"system"},invocation:{id:"invocation",name:"l5r5e.techniques.invocation",type:"system"},ritual:{id:"ritual",name:"l5r5e.techniques.ritual",type:"system"},shuji:{id:"shuji",name:"l5r5e.techniques.shuji",type:"system"},maho:{id:"maho",name:"l5r5e.techniques.maho",type:"system"},ninjutsu:{id:"ninjutsu",name:"l5r5e.techniques.ninjutsu",type:"system"},mantra:{id:"mantra",name:"l5r5e.techniques.mantra",type:"system"},school_ability:{id:"school-ability",name:"l5r5e.techniques.school_ability",type:"system"},mastery_ability:{id:"mastery-ability",name:"l5r5e.techniques.mastery_ability",type:"system"},title_ability:{id:"title-ability",name:"l5r5e.techniques.title_ability",type:"system"}},a={armor:{groupId:"armor"},equipment:{groupId:"equipment"},weapon:{groupId:"weapons"}},r={artisan:{groupId:"artisan"},martial:{groupId:"martial"},scholar:{groupId:"scholar"},social:{groupId:"social"},trade:{groupId:"trade"}},o={razor_edged:"Razor-Edged",ceremonial:"Ceremonial",damaged:"Damaged",destroyed:"Destroyed",concealable:"Concealable",cumbersome:"Cumbersome",snaring:"Snaring",unholy:"Unholy",forbidden:"Forbidden",resplendent:"Resplendent",wargear:"Wargear",mundane:"Mundane",prepare:"Prepare",sacred:"Sacred",durable:"Durable",subtle:"Subtle",kenzo_blade:"Kenzō Blade"},l={jade_inlay:"Shirogane Jade Inlay",uchema:"Uchema’s Technique",yasunori:"Yasunori Steel",akodo:"Akodo Pattern",burning_water:"Burning Watter Pattern",concealment:"Concealment Pattern",deadly_fangs:"Deadly Fangs Pattern",fearsome_snarl:"Fearsome Snarl Pattern",ichiro:"Ichirō Pattern",mountain_silk:"Mountain Silk Pattern",screaming_fire:"Screaming Fire Pattern",toriyama:"Toriyama Endurance Pattern",qamarist:"Spirit of the Qamarist Pattern",yodhaniya:"Ghostlands Yodhaniya Pattern",kokejin:"Kökejin’s Heart of the Wind Pattern",agasha:"Agasha Pattern"};let c=null;Hooks.once("tokenActionHudCoreApiReady",(async e=>{c=class Utils{static getSetting(i,s=null){let n=s??null;try{n=game.settings.get(t.ID,i)}catch{e.api.Logger.debug(`Setting '${i}' not found`)}return n}static async setSetting(i,s){try{s=await game.settings.set(t.ID,i,s),e.api.Logger.debug(`Setting '${i}' set to '${s}'`)}catch{e.api.Logger.debug(`Setting '${i}' not found`)}}}}));let d=null;Hooks.once("tokenActionHudCoreApiReady",(async t=>{d=class ActionHandler extends t.api.ActionHandler{async buildSystemActions(e){if(this.actors=this.actor?[this.actor]:this.#t(),this.tokens=this.token?[this.token]:this.#e(),this.actorType=this.actor?.type,this.displayUnequipped=c.getSetting("displayUnequipped"),this.actor){let e=this.actor.items;e=t.api.Utils.sortItemsByName(e),this.items=e}"character"===this.actorType||"npc"===this.actorType?(this.inventorygroupIds=["armor","equipment","weapons"],this.skillGroupIds=["artisan","martial","scholar","social","trade"],this.techniqueGroupIds=["kata","kiho","inversion","invocation","ritual","shuji","maho","ninjutsu","mantra","school-ability","mastery-ability","title-ability"],await this.#i()):this.actor||this.#s()}async#i(){await Promise.all([this.#n(),this.#a()]),this.#r(),this.#o()}#s(){}async#n(){if(0===this.items.size)return;const e=new Map;for(const[t,i]of this.items){const s=i.system.equipped,n=i.system?.quantity>0,a=this.#l(i);this.#c(i);const r=i.type;n&&(s&&(e.has("equipped")||e.set("equipped",new Map),e.get("equipped").set(t,i)),s||(e.has("unequipped")||e.set("unequipped",new Map),e.get("unequipped").set(t,i)),a&&("item"===r&&(e.has("equipment")||e.set("equipment",new Map),e.get("equipment").set(t,i)),"weapon"===r&&(e.has("weapons")||e.set("weapons",new Map),e.get("weapons").set(t,i)),"armor"===r&&(e.has("armor")||e.set("armor",new Map),e.get("armor").set(t,i))))}const i={equipment:t.api.Utils.i18n("l5r5e.items.title"),armor:t.api.Utils.i18n("l5r5e.armors.title"),weapons:t.api.Utils.i18n("l5r5e.weapons.title")};for(const t of this.inventorygroupIds){if(!e.has(t))continue;const s={id:t,name:i[t],type:"system"},n=e.get(t);await this.#d(n,s,t)}}#r(){const e="ring",i=this.actor.system.rings;if(0===i.length)return;const s={id:"rings",name:`${t.api.Utils.i18n("l5r5e.rings.title")}`??"rings",type:"system"},n=Object.entries(i).map((i=>{try{const s=i[0],n=[e,s].join(this.delimiter),a=`${t.api.Utils.i18n(`l5r5e.rings.${s}`)}: ${i[1]}`??"",r=i[1],o=`${`${t.api.Utils.i18n("l5r5e.rings.label")}:`??""}${a}`,l=(this.actor,t.api.Utils.getImage(`systems/l5r5e/assets/icons/rings/${s}.svg`));return{id:s,name:a,img:l,encodedValue:n,info2:"info2",tooltip:"tooltip info",listName:o}}catch(e){return t.api.Logger.error(i),null}})).filter((t=>!!t));this.addActions(n,s)}#o(){if("character"!==this.actorType)return;const e="skill";for(const i of this.skillGroupIds){const s=this.actor.system.skills[i];if(0===s.length)return;const n={id:i,name:`${t.api.Utils.i18n(`l5r5e.skills.${i}.title`)}`??i,type:"system"},a=Object.entries(s).map((s=>{try{const n=s[0],a=[e,n].join(this.delimiter),r=s[1],o=`${t.api.Utils.i18n(`l5r5e.skills.${i}.${n}`)}: ${r}`??"",l=`${t.api.Utils.i18n("l5r5e.skills.label")}: `??"";return{id:n,name:o,encodedValue:a,listName:`${l}${o}`}}catch(e){return t.api.Logger.error(s),null}})).filter((t=>!!t));this.addActions(a,n)}}async#a(t){if(0===this.items.size)return;const e=new Map;for(const[t,i]of this.items){if(this.#u(i)){const s=String(i.system.technique_type).replace("_","-");e.has(s)||e.set(s,new Map),e.get(s).set(t,i)}}for(const t of this.techniqueGroupIds){if(!e.has(t))continue;const i={id:t,type:"system"},s=e.get(t);await this.#d(s,i,"technique")}}#t(){const e=["character","npc"],i=t.api.Utils.getControlledTokens()?.filter((t=>t.actor)).map((t=>t.actor));return i.every((t=>e.includes(t.type)))?i:[]}#e(){const e=["character","npc"],i=t.api.Utils.getControlledTokens(),s=i?.filter((t=>t.actor)).map((t=>t.actor));return s.every((t=>e.includes(t.type)))?i:[]}#l(t){const e=t.type;if(this.showUnequippedItems&&!["item","technique","peculiarity"].includes(e))return!0;return!!t.system.equipped}#c(t){const e=t.type;if(["armor","item","technique","peculiarity"].includes(e))return!1;return!!t.system.readied}#u(t){if("technique"!==t.type)return!1;return!!["kata","kiho","inversion","invocation","ritual","shuji","maho","ninjutsu","mantra","school_ability","mastery_ability","title_ability"].includes(t.system.technique_type)}async#d(t,e,i="item"){if(0===t.size)return;if(!("string"==typeof e?e:e?.id))return;const s=await Promise.all([...t].map((async t=>await this.#m(i,t[1]))));this.addActions(s,e)}async#m(e,i){const n=i.id??i._id;let a=i?.name??i?.label;const r=`${`${t.api.Utils.i18n(s[e])}: `??""}${a}`;let o="";if(Object.hasOwn(i.system,"readied")){o=`toggle${i.system.readied?" active":""}`}const l=[e,n].join(this.delimiter),c=t.api.Utils.getImage(i),d=this.#p(i?.system?.activation?.type);let u=this.#y(i);const m=u?.info1,p=u?.info2,y=u?.info3,h=await this.#h(i);return{id:n,name:a,encodedValue:l,cssClass:o,img:c,icon1:d,icon2:null,info1:m,info2:p,info3:y,listName:r,tooltip:await this.#g(h)}}#p(t){}#y(t){return{info1:{text:this.#k(t)},info2:{text:this.#f(t)},info3:{text:this.#I(t)}}}#k(t){const e=t?.system?.quantity??0;return e>1?e:""}#f(t){const e=t?.system?.uses;return e&&(e.value>0||e.max>0)?`${e.value??"0"}${e.max>0?`/${e.max}`:""}`:""}#I(t){const e=t?.system?.consume?.target,i=t?.system?.consume?.type;if(e===t.id)return"";if("attribute"===i){if(!e)return"";const t=e.substr(0,e.lastIndexOf(".")),i=this.actor.system[t];return i?`${i.value??"0"}${i.max?`/${i.max}`:""}`:""}const s=this.items.get(e);if("charges"===i){const t=s?.system.uses;return t?.value?`${t.value}${t.max?`/${t.max}`:""}`:""}return s?.system?.quantity??""}async#h(t){if("none"===this.tooltipsSetting)return"";const e=t?.name??"";if("nameOnly"===this.tooltipsSetting)return e;return{name:e,description:"string"==typeof t?.system?.description?t?.system?.description:t?.system?.description?.value??"",modifiers:t?.modifiers??null,properties:[...t.system?.chatProperties??[],...t.system?.equippableItemCardProperties??[],...t.system?.activatedEffectCardProperties??[]].filter((t=>t)),rarity:t?.system?.rarity??null,traits:"weapon"===t?.type?this.#q(t?.system?.properties):null}}#q(t){return t?Object.entries(t).map((([t,e])=>e.name)):null}async#g(e){if("none"===this.tooltipsSetting)return"";if("string"==typeof e)return e;const i=t.api.Utils.i18n(e.name);if("nameOnly"===this.tooltipsSetting)return i;const s=`<h3>${i}</h3>`,n=e?.descriptionLocalised??await TextEditor.enrichHTML(t.api.Utils.i18n(e?.description??""),{async:!0}),a=e?.rarity?`<span class="tah-tag legendary">${e.rarity}</span>`:"",r=e?.traits?`<div class="tah-properties">${e.traits.map((t=>`<span class="tah-property">${t}</span>`)).join("")}</div>`:"",o='<div class="tah-tags"><span class="tah-tag tah-tag-transparent">modifiersHtml</span></div>',l=[a,'<span class="tah-tag">traitsHtml</span>','<span class="tah-tag tah-tag-secondary">traits2Html</span>','<span class="tah-tag tah-tag-alt">traitsAltHtml</span>'].join(""),c=l?`<div class="tah-tags">${l}</div>`:"";return`<div>${s}${`<div class="tah-tags-wrapper">${c}${o}</div>`}${n}${r}</div>`}}}));let u=null;Hooks.once("tokenActionHudCoreApiReady",(async t=>{u=class RollHandler extends t.api.RollHandler{async handleActionClick(t,e){const[i,s]=e.split("|");if(["item"].includes(i)&&this.isRenderItem())return this.doRenderItem(this.actor,s);const n=["character"];if(this.actor)return void await this.#b(t,this.actor,this.token,i,s);const a=canvas.tokens.controlled.filter((t=>n.includes(t.actor?.type)));for(const e of a){const n=e.actor;await this.#b(t,n,e,i,s)}}async handleActionHover(t,e){}async handleGroupClick(t,e){}async#b(t,e,i,s,n){switch(console.log(s),s){case"weapons":this.#A(t,e,n);break;case"ring":this.#v(t,e,n);break;case"skill":this.#w(t,e,n);break;case"technique":this.#_(t,e,n);break;case"item":this.#$(t,e,n);break;case"utility":this.#U(i,n)}}#$(t,e,i){const s=e.items.get(i);console.log(s),s.toChat(t)}#A(t,e,i){const s=e.items.get(i);new game.l5r5e.DicePickerDialog({skillId:s.system.skill}).render(!0)}#v(t,e,i){new game.l5r5e.DicePickerDialog({ringId:i}).render(!0)}#w(t,e,i){new game.l5r5e.DicePickerDialog({skillId:i}).render(!0)}#_(t,e,i){const s=e.items.get(i);s&&"technique"===s.type&&s.system.skill&&new game.l5r5e.DicePickerDialog({skillsList:s.system.skill,ringId:s.system.ring,difficulty:s.system.difficulty}).render(!0)}async#U(t,e){if("endTurn"===e)game.combat?.current?.tokenId===t.id&&await(game.combat?.nextTurn())}}}));let m=null;function register(e){game.settings.register(t.ID,"displayUnequipped",{name:game.i18n.localize("tokenActionHud.template.settings.displayUnequipped.name"),hint:game.i18n.localize("tokenActionHud.template.settings.displayUnequipped.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}})}Hooks.once("tokenActionHudCoreApiReady",(async t=>{const e=n;Object.values(e).forEach((e=>{e.name=t.api.Utils.i18n(e.name),e.listName=`Group: ${t.api.Utils.i18n(e.listName??e.name)}`}));const i=Object.values(e);m={layout:[{nestId:"inventory",id:"inventory",name:t.api.Utils.i18n("l5r5e.sheets.inventory"),groups:[{...e.weapons,nestId:"inventory_weapons"},{...e.armor,nestId:"inventory_armor"},{...e.equipment,nestId:"inventory_items"}]},{nestId:"attributes",id:"attributes",name:t.api.Utils.i18n("l5r5e.attributes.title"),groups:[{...e.rings,nestId:"attributes_rings"},{...e.derived,nestId:"attributes_derived"},{...e.standing,nestId:"attributes_standing"}]},{nestId:"skills",id:"skills",name:t.api.Utils.i18n("l5r5e.skills.title"),groups:[{...e.artisan,nestId:"skills_artisan"},{...e.martial,nestId:"skills_martial"},{...e.scholar,nestId:"skills_scholar"},{...e.social,nestId:"skills_social"},{...e.trade,nestId:"skills_trade"}]},{nestId:"techniques",id:"techniques",name:t.api.Utils.i18n("l5r5e.techniques.title"),groups:[{...e.school_ability,nestId:"techniques_school"},{...e.mastery,nestId:"techniques_mastery"},{...e.kata,nestId:"techniques_kata"},{...e.kiho,nestId:"techniques_kiho"},{...e.inversion,nestId:"techniques_inversion"},{...e.invocation,nestId:"techniques_invocation"},{...e.ritual,nestId:"techniques_ritual"},{...e.shuji,nestId:"techniques_shuji"},{...e.maho,nestId:"techniques_maho"},{...e.ninjutsu,nestId:"techniques_ninjutsu"},{...e.mantra,nestId:"techniques_mantra"},{...e.titleAbility,nestId:"techniques_title"}]},{nestId:"utility",id:"utility",name:t.api.Utils.i18n("tokenActionHud.utility"),groups:[{...e.combat,nestId:"utility_combat"},{...e.token,nestId:"utility_token"},{...e.rests,nestId:"utility_rests"},{...e.utility,nestId:"utility_utility"}]}],groups:i}}));let p=null;Hooks.once("tokenActionHudCoreApiReady",(async e=>{p=class SystemManager extends e.api.SystemManager{getActionHandler(){return new d}getAvailableRollHandlers(){return{core:"Core Template"}}getRollHandler(t){let e;return e=new u,e}async registerDefaults(){return m}registerSettings(t){register(t)}registerStyles(){return{template:{class:"tah-l5r5e",file:"tah-l5r5e-style",moduleId:t.ID,name:"L5r5e Style"}}}}})),Hooks.on("tokenActionHudCoreApiReady",(async()=>{const e=game.modules.get(t.ID);e.api={requiredCoreModuleVersion:"1.5",SystemManager:p},Hooks.call("tokenActionHudSystemReady",e)}));export{s as ACTION_TYPE,d as ActionHandler,e as CORE_MODULE,m as DEFAULTS,n as GROUP,l as ITEM_PATTERN,o as ITEM_QUALITIES,a as ITEM_TYPE,t as MODULE,i as REQUIRED_CORE_MODULE_VERSION,u as RollHandler,r as SKILL_TYPE,p as SystemManager,c as Utils,register};
